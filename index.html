<!DOCTYPE HTML>
<html>
  <head>
    <link rel="stylesheet" href="style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <title>JustMusic</title>
  </head>
  <body>
    <iframe id="frame" style="display:none" frameborder="0"></iframe>
    <script>
      function maximize() {
        frame.width = "101%"
        frame.height = "101%"
        frame.classList = ""
        setTimeout(function() {
          frame.style.top = "0"
          frame.style.left = "0"
          frame.style.bottom = ""
          frame.style.right = ""
          toggle.innerHTML = "keyboard_arrow_down"
        },500)
      }

      function minimize() {
        toggle.innerHTML = "keyboard_arrow_up"
        frame.style.top = ""
        frame.style.left = ""
        frame.classList = "minimized"
        frame.style.bottom = "0"
        frame.style.right = "0"
        frame.width = "20%"
        frame.height = ""
      }

      function toggleMM() {
        if (toggle.innerHTML == "keyboard_arrow_down") {
          minimize()
        } else {
          maximize()
        }
      }

      function loadList(list,start) {
        frame.style.display = "block"
        frame.src = "player?list=" + list + "&startAt=" + start
        setTimeout(maximize,10)
      }

      function loadSong(id) {
        frame.style.display = "block"
        frame.src = "player?v=" + id
        setTimeout(maximize,10)
      }

      var toggle = document.createElement("div")
      toggle.id = "toggle"
      toggle.classList = "material-symbols-outlined"
      toggle.onclick = toggleMM
      toggle.innerHTML = "keyboard_arrow_down"
      frame.onload = function() {this.contentDocument.documentElement.appendChild(toggle)}

      async function getInfo(id,handoff) {
        var resp = await (await fetch("https://www.googleapis.com/youtube/v3/videos?key=AIzaSyA-ZFrKnMfSPvRnNzk2g7rMNuAEGnCmn00&id=" + id + "&part=snippet,contentDetails")).json();
        var json = {}
        if (resp.items) {
          var video = resp.items[0]
          var duration = video.contentDetails.duration.replace("PT","").split("M")
          duration[1] = duration[1].replace("S","")
          json.duration = `${duration[0]}:${duration[1]}`
          json.cover = video.snippet.thumbnails.maxres.url
          json.title = video.snippet.title
          json.artist = video.snippet.channelTitle.replace(" - Topic","")
          handoff(json)
        } else {
          alert("Error getting metadata for video id " + id)
        }
      }
      
      async function getList(id,elem) {
        var resp = await (await fetch("https://www.googleapis.com/youtube/v3/playlistItems?key=AIzaSyA-ZFrKnMfSPvRnNzk2g7rMNuAEGnCmn00&playlistId=" + id + "&part=contentDetails")).json();
        if (resp.items) {
          var ids = []
          resp.items.forEach(function(k,index) {
            ids.push(k.contentDetails.videoId)
            getInfo(k.contentDetails.videoId,function(data) {
              var item = document.createElement("div")
              item.style = "display:flex;align-items:center;"
              item.innerHTML = `<img class="thumbnail" src="${data.cover}" height="10%"><div><strong>${data.title}</strong><br>${data.artist}</div><div style="margin-left:auto">${data.duration}</div>`
              item.onclick = function() {
                loadList(ids,index)
              }
              elem.appendChild(item)
            })
          })
        } else {
          alert("Error getting playlist")
        }
      }
    </script>
  </body>
</html>
